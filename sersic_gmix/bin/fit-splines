#!/usr/bin/env python
"""
We don't actually use the file here, but save the combined
data and do the fit on the fly
"""

from __future__ import print_function

import os
import sys
from numpy import array
import fitsio
import sersic_gmix
from sersic_gmix.fitting import get_fname
import esutil as eu

import pickle

def main():

    ngauss=int(sys.argv[1])
    nvals=sys.argv[2:]

    nvals=[float(n) for n in nvals]

    fnames=[get_fname(n,ngauss,'fit',ext='fits') for n in nvals]

    data0=eu.io.read(fnames,combine=True)
    data=sersic_gmix.spline_fitting.renorm(data0)
    nvals=array(nvals)

    T_splines=sersic_gmix.spline_fitting.fit_spline(data, nvals, 'T')
    flux_splines=sersic_gmix.spline_fitting.fit_spline(data, nvals, 'flux')

    spline_data={'nvals':nvals,
                 'T_splines':T_splines,
                 'flux_splines':flux_splines}

    pfile=sersic_gmix.fitting.get_spline_fname(ngauss)

    print(pfile)
    with open(pfile,'w') as fobj:
        pickle.dump(spline_data, fobj)

    fitsname=sersic_gmix.fitting.get_combined_fname(ngauss)
    print(fitsname)
    fitsio.write(fitsname, data, clobber=True)

main()
