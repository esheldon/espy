#!/usr/bin/env python
"""
        loadall [options]

Run uptime on all /data disks on the astro cluster to get the load average.
Also show totals for the entire system.
"""

import os
import sys
from optparse import OptionParser

parser=OptionParser(__doc__)

NMACHINE=34
#NMACHINE=3
#MACHINE_SKIP=['astro0034']
MACHINE_SKIP=[]


def get_loads():

    uplist=[]
    for i in xrange(1,NMACHINE+1):

        machine = 'astro%04d' % i
        if machine in MACHINE_SKIP:
            continue

        command="""
            ssh %s uptime | awk '{printf "%s %%5.2f %%5.2f %%5.2f\\n",$10,$11,$12}'
        """.strip()
        command = command % (machine,machine)

        si,so=os.popen2(command)
        uptime=so.read().strip()

        if uptime == '':
            print 'Could not get uptime for machine %s' % machine
        else:
            #uptime_with_name = '%s %s' % (machine,uptime)
            #uplist.append(uptime_with_name)
            uplist.append(uptime)

    return uplist


def print_loads(uplist):

    head1 = '       load average'
    head2 = '              1     5    15'
    uplist = [head1,head2] + uplist
    uplist = '\n'.join(uplist)

    print uplist


def main():

    options, args = parser.parse_args(sys.argv[1:])

    uplist = get_loads()
    print_loads(uplist)


main()
