#!/usr/bin/env python
"""
    %prog [options] run gnum

combine outputs
"""

from __future__ import print_function

import os,sys
import fitsio

from great_des import files

from optparse import OptionParser
parser = OptionParser(__doc__)

def main():
    options, args = parser.parse_args(sys.argv[1:])
    if len(args) < 2:
        parser.print_help()
        sys.exit(45)

    run=args[0]
    gnum=int(args[1])

    conf=files.read_config(run=run)

    conf['gnum'] = gnum

    nper=conf['nper']

    output_file = files.get_output_file(**conf)
    print(output_file)

    first=True
    with fitsio.FITS(output_file,'rw',clobber=True) as fobj:
        for fnum in xrange(conf['nf']):
            conf['fnum'] = fnum

            low,high = files.get_chunk_ranges(**conf)
            n=len(low)

            dlist=[]
            for i in xrange(n):
                conf['start'] = low[i]
                conf['end'] = high[i]
                data = files.read_output(**conf)

                if data.size != nper:
                    err="data size mismatch: expected %d got %d"
                    raise IOError(err % (nper,data.size))


                if first:
                    fobj.write(data)
                    first=False
                else:
                    fobj[-1].append(data)

    print(output_file)

main()
